name: Deploy Bus Tracking System

on:
  push:
    branches:
      - main
      - master # Support both main and master branches
  workflow_dispatch: # Allow manual triggering
    inputs:
      stage:
        description: "Deployment stage"
        required: false
        default: "dev"
        type: choice
        options:
          - dev
          - staging
          - prod

env:
  NODE_VERSION: "18"
  AWS_REGION: ${{ secrets.AWS_REGION || 'us-east-1' }}

jobs:
  test:
    name: Test and Lint
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¦ Checkout code
        uses: actions/checkout@v4

      - name: ğŸš€ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: ğŸ“¥ Install dependencies
        run: |
          npm ci
          echo "âœ… Dependencies installed successfully"

      - name: ğŸ” Run ESLint
        run: |
          echo "ğŸ” Running ESLint..."
          npm run lint
          echo "âœ… Linting completed successfully"

      - name: ğŸ§ª Run tests with coverage
        run: |
          echo "ğŸ§ª Running tests with coverage..."
          npm test -- --coverage --verbose
          echo "âœ… Tests completed successfully"

      - name: ğŸ“Š Upload coverage reports
        uses: codecov/codecov-action@v3
        with:
          file: ./coverage/lcov.info
          flags: unittests
          name: codecov-umbrella
          fail_ci_if_error: false

  deploy-dev:
    name: Deploy to Development
    runs-on: ubuntu-latest
    needs: test
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master' || github.event_name == 'workflow_dispatch'

    environment:
      name: development
      url: https://api-dev.bus-tracking.com

    steps:
      - name: ğŸ“¦ Checkout code
        uses: actions/checkout@v4

      - name: ğŸš€ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: ğŸ“¥ Install dependencies
        run: |
          npm ci
          echo "âœ… Dependencies installed for deployment"

      - name: ğŸ”§ Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: ğŸ” Validate AWS credentials
        run: |
          echo "ğŸ” Validating AWS credentials..."
          echo "AWS Region: ${{ env.AWS_REGION }}"
          echo "Checking if credentials are available..."
          if [ -z "${{ secrets.AWS_ACCESS_KEY_ID }}" ]; then
            echo "âŒ AWS_ACCESS_KEY_ID secret is not set"
            exit 1
          fi
          if [ -z "${{ secrets.AWS_SECRET_ACCESS_KEY }}" ]; then
            echo "âŒ AWS_SECRET_ACCESS_KEY secret is not set"
            exit 1
          fi
          aws sts get-caller-identity
          echo "âœ… AWS credentials validated"

      - name: ğŸ“¦ Install Serverless Framework
        run: |
          npm install -g serverless@3
          echo "âœ… Serverless Framework installed"

      - name: ï¿½ Validate Serverless Configuration
        run: |
          echo "ğŸ”§ Validating serverless.yml configuration..."
          sls print --stage dev --region ${{ env.AWS_REGION }}
          echo "âœ… Serverless configuration is valid"

      - name: ï¿½ğŸš€ Deploy to Development
        run: |
          echo "ğŸš€ Deploying to development stage..."
          sls deploy --stage dev --region ${{ env.AWS_REGION }} --verbose
          echo "âœ… Deployment to development completed"
        env:
          STAGE: dev

      - name: ğŸ§ª Post-deployment health check
        run: |
          echo "ğŸ§ª Running post-deployment health check..."
          # Wait for deployment to stabilize
          sleep 30

          # Get the health check endpoint from serverless output
          HEALTH_ENDPOINT=$(sls info --stage dev --region ${{ env.AWS_REGION }} | grep -o 'https://[^/]*\.execute-api\.[^/]*\.amazonaws\.com/dev/status/ping' | head -1)

          if [ -n "$HEALTH_ENDPOINT" ]; then
            echo "ğŸ” Testing health endpoint: $HEALTH_ENDPOINT"
            
            # Test health endpoint with retry logic
            for i in {1..5}; do
              if curl -f -s "$HEALTH_ENDPOINT" > /dev/null; then
                echo "âœ… Health check passed on attempt $i"
                curl -s "$HEALTH_ENDPOINT" | jq '.'
                break
              else
                echo "âŒ Health check failed on attempt $i, retrying in 10 seconds..."
                sleep 10
              fi
              
              if [ $i -eq 5 ]; then
                echo "âŒ Health check failed after 5 attempts"
                exit 1
              fi
            done
          else
            echo "âš ï¸ Could not determine health endpoint, skipping health check"
          fi

      - name: ğŸ“ Save deployment info
        run: |
          echo "ğŸ“ Saving deployment information..."
          sls info --stage dev --region ${{ env.AWS_REGION }} > deployment-info-dev.txt
          echo "âœ… Deployment info saved"

      - name: ğŸ“¤ Upload deployment artifacts
        uses: actions/upload-artifact@v3
        with:
          name: deployment-info-dev
          path: deployment-info-dev.txt
          retention-days: 30

  deploy-staging:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    needs: deploy-dev
    if: github.ref == 'refs/heads/main' || (github.event_name == 'workflow_dispatch' && github.event.inputs.stage != 'dev')

    environment:
      name: staging
      url: https://api-staging.bus-tracking.com

    steps:
      - name: ğŸ“¦ Checkout code
        uses: actions/checkout@v4

      - name: ğŸš€ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: ğŸ“¥ Install dependencies
        run: |
          npm ci
          echo "âœ… Dependencies installed for staging deployment"

      - name: ğŸ”§ Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: ğŸ“¦ Install Serverless Framework
        run: |
          npm install -g serverless@3
          echo "âœ… Serverless Framework installed"

      - name: ğŸš€ Deploy to Staging
        run: |
          echo "ğŸš€ Deploying to staging stage..."
          sls deploy --stage staging --region ${{ env.AWS_REGION }} --verbose
          echo "âœ… Deployment to staging completed"
        env:
          STAGE: staging

  deploy-production:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: deploy-staging
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.stage == 'prod'

    environment:
      name: production
      url: https://api.bus-tracking.com

    steps:
      - name: ğŸ“¦ Checkout code
        uses: actions/checkout@v4

      - name: ğŸš€ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: ğŸ“¥ Install dependencies
        run: |
          npm ci
          echo "âœ… Dependencies installed for production deployment"

      - name: ğŸ”§ Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: ğŸ“¦ Install Serverless Framework
        run: |
          npm install -g serverless@3
          echo "âœ… Serverless Framework installed"

      - name: ğŸš€ Deploy to Production
        run: |
          echo "ğŸš€ Deploying to production stage..."
          sls deploy --stage prod --region ${{ env.AWS_REGION }} --verbose
          echo "âœ… Deployment to production completed"
        env:
          STAGE: prod

      - name: ğŸ§ª Production smoke tests
        run: |
          echo "ğŸ§ª Running production smoke tests..."
          # Add your production smoke tests here
          echo "âœ… Production smoke tests completed"

  notify:
    name: Notify Deployment Status
    runs-on: ubuntu-latest
    needs: [test, deploy-dev]
    if: always()

    steps:
      - name: ï¿½ Debug Job Results
        run: |
          echo "ğŸ“Š Job Results Summary:"
          echo "Test Job Result: ${{ needs.test.result }}"
          echo "Deploy Dev Job Result: ${{ needs.deploy-dev.result }}"

      - name: ï¿½ğŸ“¢ Deployment Success Notification
        if: needs.deploy-dev.result == 'success' && needs.test.result == 'success'
        run: |
          echo "ğŸ‰ Deployment completed successfully!"
          echo "âœ… Bus Tracking System deployed to development environment"
          echo "ğŸ”— Check the deployment at your AWS Console"

      - name: ğŸ“¢ Test Failure Notification
        if: needs.test.result == 'failure'
        run: |
          echo "âŒ Tests failed!"
          echo "ğŸ” Please check the test logs above for details"
          echo "ğŸ“ Common test issues:"
          echo "   - Linting errors in code"
          echo "   - Unit test failures"
          echo "   - Syntax errors in JavaScript"

      - name: ğŸ“¢ Deployment Failure Notification
        if: needs.deploy-dev.result == 'failure'
        run: |
          echo "âŒ Deployment failed!"
          echo "ğŸ” Please check the deployment logs above for details"
          echo "ğŸ“ Common deployment issues:"
          echo "   - AWS credentials not configured properly"
          echo "   - Insufficient IAM permissions"
          echo "   - Serverless configuration errors"
          echo "   - Resource conflicts in AWS"

      - name: ğŸ“¢ Overall Status
        run: |
          if [[ "${{ needs.test.result }}" == "success" && "${{ needs.deploy-dev.result }}" == "success" ]]; then
            echo "âœ… All jobs completed successfully!"
            exit 0
          else
            echo "âŒ One or more jobs failed. Check the logs above."
            exit 1
          fi
